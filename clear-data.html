<!DOCTYPE html>
<html>
<head>
    <title>Clear All Extension Data</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 500px; margin: 0 auto; }
        .warning { background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107; }
        .danger { background: #f8d7da; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #dc3545; }
        .success { background: #d4edda; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #28a745; }
        button { padding: 12px 24px; margin: 10px 5px; cursor: pointer; border: none; border-radius: 6px; font-size: 16px; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-success { background: #28a745; color: white; }
        .btn-primary { background: #007bff; color: white; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 6px; font-size: 14px; }
    </style>
</head>
<body>
    <h1>üßπ Extension Data Management</h1>
    
    <div class="warning">
        <h3>‚ö†Ô∏è Sample Data Issue Fixed</h3>
        <p><strong>Problem:</strong> Sample job applications were being recreated every time you logged out and back in.</p>
        <p><strong>Solution:</strong> Disabled automatic sample data creation. Sample data will no longer reappear after logout.</p>
    </div>

    <div class="danger">
        <h3>üóëÔ∏è Clear All Data (Use with caution)</h3>
        <p>This will permanently delete ALL job applications, authentication data, and settings from the extension.</p>
        <button class="btn-danger" onclick="clearAllData()">Clear All Extension Data</button>
    </div>

    <div>
        <h3>üìä Storage Information</h3>
        <button class="btn-primary" onclick="checkStorage()">Check Current Storage</button>
        <button class="btn-warning" onclick="exportBeforeClear()">Export Data Before Clearing</button>
        <pre id="storageInfo">Click "Check Current Storage" to see what's stored...</pre>
    </div>

    <div>
        <h3>üß™ Testing Options</h3>
        <button class="btn-success" onclick="createTestData()">Create Sample Data (Manual)</button>
        <p><em>This will ask for confirmation before creating sample applications.</em></p>
    </div>

    <div id="results"></div>

    <script>
        const log = (message, type = 'info') => {
            const output = document.getElementById('storageInfo');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            console.log(message);
        };

        const showResult = (message, type = 'success') => {
            const resultsDiv = document.getElementById('results');
            const className = type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'success';
            resultsDiv.innerHTML = `<div class="${className}"><p>${message}</p></div>`;
        };

        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è This will permanently delete ALL your job applications, authentication data, and settings. Are you sure?')) {
                return;
            }

            if (!confirm('üö® FINAL WARNING: This action cannot be undone. All data will be lost forever. Continue?')) {
                return;
            }

            try {
                log('Starting complete data wipe...', 'warning');
                
                // Clear sync storage
                await new Promise((resolve) => {
                    chrome.storage.sync.clear(() => {
                        if (chrome.runtime.lastError) {
                            log('Sync storage clear error: ' + chrome.runtime.lastError.message, 'error');
                        } else {
                            log('‚úÖ Sync storage cleared');
                        }
                        resolve();
                    });
                });

                // Clear local storage
                await new Promise((resolve) => {
                    chrome.storage.local.clear(() => {
                        if (chrome.runtime.lastError) {
                            log('Local storage clear error: ' + chrome.runtime.lastError.message, 'error');
                        } else {
                            log('‚úÖ Local storage cleared');
                        }
                        resolve();
                    });
                });

                // Clear authentication
                try {
                    await chrome.runtime.sendMessage({ action: 'logout' });
                    log('‚úÖ Authentication cleared');
                } catch (error) {
                    log('Auth clear error: ' + error.message, 'warning');
                }

                showResult('üßπ All extension data has been cleared successfully!', 'success');
                log('=== COMPLETE DATA WIPE FINISHED ===', 'success');
                
            } catch (error) {
                log('Error during data clearing: ' + error.message, 'error');
                showResult('‚ùå Error clearing data: ' + error.message, 'error');
            }
        }

        async function checkStorage() {
            try {
                log('Checking storage usage...');
                document.getElementById('storageInfo').textContent = '';

                // Check sync storage
                const syncData = await new Promise((resolve) => {
                    chrome.storage.sync.get(null, resolve);
                });

                // Check local storage  
                const localData = await new Promise((resolve) => {
                    chrome.storage.local.get(null, resolve);
                });

                // Get storage usage
                const syncUsage = await new Promise((resolve) => {
                    chrome.storage.sync.getBytesInUse(null, resolve);
                });

                const localUsage = await new Promise((resolve) => {
                    chrome.storage.local.getBytesInUse(null, resolve);
                });

                log(`=== STORAGE REPORT ===`);
                log(`Sync Storage: ${syncUsage} bytes used`);
                log(`Sync Storage Items: ${Object.keys(syncData).length}`);
                log(`Sync Storage Keys: ${Object.keys(syncData).join(', ')}`);
                log(`\nLocal Storage: ${localUsage} bytes used`);
                log(`Local Storage Items: ${Object.keys(localData).length}`);
                log(`Local Storage Keys: ${Object.keys(localData).join(', ')}`);

                if (syncData.jobApplications) {
                    log(`\nJob Applications (sync): ${syncData.jobApplications.length}`);
                }
                if (localData.jobApplications) {
                    log(`Job Applications (local): ${localData.jobApplications.length}`);
                }

                if (syncData.isAuthenticated) {
                    log(`Authentication Status: ${syncData.isAuthenticated ? 'Logged In' : 'Logged Out'}`);
                    if (syncData.userProfile) {
                        log(`User: ${syncData.userProfile.name || syncData.userProfile.email || 'Unknown'}`);
                    }
                }

            } catch (error) {
                log('Error checking storage: ' + error.message, 'error');
            }
        }

        async function exportBeforeClear() {
            try {
                log('Exporting data before clearing...', 'warning');
                
                const response = await chrome.runtime.sendMessage({ action: 'exportToCSV' });
                if (response && response.success && response.data) {
                    // Create download
                    const blob = new Blob([response.data], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `job-applications-backup-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showResult('‚úÖ Data exported successfully! Check your downloads folder.', 'success');
                    log('‚úÖ Data exported successfully');
                } else {
                    showResult('‚ùå No data to export or export failed', 'error');
                    log('No data to export', 'warning');
                }
            } catch (error) {
                log('Export error: ' + error.message, 'error');
                showResult('‚ùå Export failed: ' + error.message, 'error');
            }
        }

        async function createTestData() {
            try {
                log('Requesting sample data creation...');
                
                const response = await chrome.runtime.sendMessage({ action: 'createSampleData' });
                if (response && response.success) {
                    showResult('‚úÖ Sample data created successfully!', 'success');
                    log('‚úÖ Sample data created');
                } else {
                    showResult('‚ùå Failed to create sample data', 'error');
                    log('Failed to create sample data', 'error');
                }
            } catch (error) {
                log('Sample data error: ' + error.message, 'error');
                showResult('‚ùå Error: ' + error.message, 'error');
            }
        }

        // Auto-check storage on load
        setTimeout(checkStorage, 1000);
    </script>
</body>
</html>
