<!DOCTYPE html>
<html>
<head>
  <title>Personal Recruiter - Debug Console</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    .debug-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    button {
      background: #4285f4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #3367d6;
    }
    .output {
      background: #f8f9fa;
      border: 1px solid #e1e4e8;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .info { color: #17a2b8; }
  </style>
</head>
<body>
  <h1>Personal Recruiter Extension - Debug Console</h1>
  
  <div class="debug-panel">
    <h3>üîç Extension Status</h3>
    <button onclick="checkExtensionStatus()">Check Extension Status</button>
    <button onclick="viewStorageData()">View Storage Data</button>
    <button onclick="clearStorageData()">Clear All Data</button>
    <div id="status-output" class="output"></div>
  </div>

  <div class="debug-panel">
    <h3>üìù Manual Testing</h3>
    <button onclick="testManualSave()">Test Manual Save</button>
    <button onclick="testGetApplications()">Test Get Applications</button>
    <button onclick="testAuthentication()">Test Authentication</button>
    <div id="test-output" class="output"></div>
  </div>

  <div class="debug-panel">
    <h3>üåê Content Script Testing</h3>
    <button onclick="injectContentScript()">Inject Content Script</button>
    <button onclick="testJobDetection()">Test Job Detection</button>
    <div id="content-output" class="output"></div>
  </div>

  <script>
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const formatted = `[${timestamp}] ${message}\n`;
      
      // Log to multiple outputs
      ['status-output', 'test-output', 'content-output'].forEach(id => {
        const output = document.getElementById(id);
        if (output && (type === 'info' || id === 'status-output')) {
          output.innerHTML += `<span class="${type}">${formatted}</span>`;
          output.scrollTop = output.scrollHeight;
        }
      });
      
      console.log(message);
    }

    async function checkExtensionStatus() {
      log('üîç Checking extension status...', 'info');
      
      try {
        if (!chrome.runtime) {
          log('‚ùå Chrome runtime not available', 'error');
          return;
        }
        
        const manifest = chrome.runtime.getManifest();
        log(`‚úÖ Extension loaded: ${manifest.name} v${manifest.version}`, 'success');
        
        // Test background script communication
        const response = await sendMessage({ action: 'getAuthStatus' });
        log(`üì° Background script responding: ${response.success}`, 'success');
        
      } catch (error) {
        log(`‚ùå Extension check failed: ${error.message}`, 'error');
      }
    }

    async function viewStorageData() {
      log('üì¶ Retrieving storage data...', 'info');
      
      try {
        chrome.storage.sync.get(null, (data) => {
          log(`üìä Storage data:`, 'info');
          log(`- Authentication: ${data.isAuthenticated || 'false'}`, 'info');
          log(`- User: ${data.userProfile?.name || 'None'}`, 'info');
          log(`- Applications: ${(data.jobApplications || []).length}`, 'info');
          
          if (data.jobApplications && data.jobApplications.length > 0) {
            log(`üìã Recent applications:`, 'info');
            data.jobApplications.slice(0, 3).forEach((app, i) => {
              log(`  ${i+1}. ${app.jobTitle} at ${app.company}`, 'info');
            });
          }
        });
      } catch (error) {
        log(`‚ùå Storage check failed: ${error.message}`, 'error');
      }
    }

    async function clearStorageData() {
      log('üóëÔ∏è Clearing storage data...', 'info');
      
      try {
        chrome.storage.sync.clear(() => {
          if (chrome.runtime.lastError) {
            log(`‚ùå Clear failed: ${chrome.runtime.lastError.message}`, 'error');
          } else {
            log('‚úÖ Storage data cleared successfully', 'success');
          }
        });
      } catch (error) {
        log(`‚ùå Clear failed: ${error.message}`, 'error');
      }
    }

    async function testManualSave() {
      log('üíæ Testing manual application save...', 'info');
      
      const testApp = {
        jobTitle: 'Senior Software Developer',
        company: 'Tech Company Inc.',
        url: 'https://example.com/jobs/senior-dev',
        jobId: 'test-' + Date.now(),
        status: 'Applied',
        notes: 'Test application created from debug console',
        manual: true
      };
      
      try {
        const response = await sendMessage({
          action: 'saveJobApplication',
          data: testApp
        });
        
        if (response.success) {
          log('‚úÖ Test application saved successfully!', 'success');
          log(`üìù Saved: ${testApp.jobTitle} at ${testApp.company}`, 'info');
        } else {
          log(`‚ùå Save failed: ${response.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Save test failed: ${error.message}`, 'error');
      }
    }

    async function testGetApplications() {
      log('üìã Testing get applications...', 'info');
      
      try {
        const response = await sendMessage({ action: 'getJobApplications' });
        
        if (response.success) {
          const apps = response.data || [];
          log(`‚úÖ Retrieved ${apps.length} applications`, 'success');
          
          if (apps.length > 0) {
            log('üìä Applications found:', 'info');
            apps.slice(0, 5).forEach((app, i) => {
              log(`  ${i+1}. ${app.jobTitle} at ${app.company} (${new Date(app.timestamp).toLocaleDateString()})`, 'info');
            });
          } else {
            log('üì≠ No applications found', 'info');
          }
        } else {
          log(`‚ùå Get applications failed: ${response.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Get applications test failed: ${error.message}`, 'error');
      }
    }

    async function testAuthentication() {
      log('üîê Testing authentication status...', 'info');
      
      try {
        const response = await sendMessage({ action: 'getAuthStatus' });
        
        if (response.success) {
          log('‚úÖ Authentication check successful', 'success');
          log(`üìä Auth status: ${JSON.stringify(response.data)}`, 'info');
        } else {
          log(`‚ùå Auth check failed: ${response.error || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Auth test failed: ${error.message}`, 'error');
      }
    }

    async function injectContentScript() {
      log('üíâ Injecting content script into current tab...', 'info');
      
      try {
        const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
        const currentTab = tabs[0];
        
        log(`üåê Current tab: ${currentTab.url}`, 'info');
        
        await chrome.scripting.executeScript({
          target: { tabId: currentTab.id },
          files: ['content.js']
        });
        
        log('‚úÖ Content script injected successfully', 'success');
      } catch (error) {
        log(`‚ùå Content script injection failed: ${error.message}`, 'error');
      }
    }

    async function testJobDetection() {
      log('üîç Testing job detection on current page...', 'info');
      
      try {
        const tabs = await chrome.tabs.query({ active: true, currentWindow: true });
        const currentTab = tabs[0];
        
        // Send message to content script
        chrome.tabs.sendMessage(currentTab.id, { type: 'FORCE_DETECTION' }, (response) => {
          if (chrome.runtime.lastError) {
            log(`‚ùå Content script not responding: ${chrome.runtime.lastError.message}`, 'error');
          } else {
            log('‚úÖ Job detection test sent to content script', 'success');
            log(`üìä Response: ${JSON.stringify(response)}`, 'info');
          }
        });
      } catch (error) {
        log(`‚ùå Job detection test failed: ${error.message}`, 'error');
      }
    }

    function sendMessage(message, timeout = 10000) {
      return new Promise((resolve, reject) => {
        const timer = setTimeout(() => {
          reject(new Error('Message timeout'));
        }, timeout);
        
        chrome.runtime.sendMessage(message, (response) => {
          clearTimeout(timer);
          if (chrome.runtime.lastError) {
            reject(chrome.runtime.lastError);
          } else {
            resolve(response);
          }
        });
      });
    }

    // Auto-run status check on load
    document.addEventListener('DOMContentLoaded', () => {
      log('üöÄ Debug console loaded', 'success');
      checkExtensionStatus();
    });
  </script>
</body>
</html>
